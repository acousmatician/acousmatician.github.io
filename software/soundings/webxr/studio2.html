<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>1980s Tape Studio â€“ A-Frame + Web Audio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Web Audio + A-Frame integration -->
    <script>
      // Global audio system for the studio
      AFRAME.registerSystem('studio-audio', {
        init: function () {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if (!AudioContext) {
            console.warn('Web Audio API not supported in this browser.');
            return;
          }

          this.context = new AudioContext();
          this.masterGain = this.context.createGain();
          this.masterGain.gain.value = 0.9;
          this.masterGain.connect(this.context.destination);

          this.buffer = null;
          this.currentSource = null;

          // Load a tape loop sample (replace with your own path if needed)
          this.loadSample('audio/DarkGlass.wav');
        },

        loadSample: function (url) {
          const sys = this;
          if (!this.context) return;

          fetch(url)
            .then(function (response) {
              return response.arrayBuffer();
            })
            .then(function (arrayBuffer) {
              return sys.context.decodeAudioData(arrayBuffer);
            })
            .then(function (audioBuffer) {
              sys.buffer = audioBuffer;
              console.log('Tape loop loaded:', url);
            })
            .catch(function (err) {
              console.error('Error loading audio:', err);
            });
        },

        playLoop: function () {
          if (!this.context || !this.buffer) {
            console.warn('Audio not ready yet.');
            return;
          }

          // Stop any existing source
          this.stopLoop();

          const source = this.context.createBufferSource();
          source.buffer = this.buffer;
          source.loop = true;
          source.connect(this.masterGain);
          source.start();

          this.currentSource = source;
          console.log('Tape playing');
        },

        stopLoop: function () {
          if (this.currentSource) {
            try {
              this.currentSource.stop();
            } catch (e) {
              // ignore
            }
            this.currentSource.disconnect();
            this.currentSource = null;
            console.log('Tape stopped');
          }
        }
      });

      // Component for the PLAY button
      AFRAME.registerComponent('play-tape', {
        init: function () {
          this.onClick = this.onClick.bind(this);
          this.el.addEventListener('click', this.onClick);
        },
        remove: function () {
          this.el.removeEventListener('click', this.onClick);
        },
        onClick: function () {
          const sceneEl = this.el.sceneEl;
          const sys = sceneEl.systems['studio-audio'];

          if (!sys || !sys.context) return;

          // Resume audio context on user gesture (required by browsers)
          if (sys.context.state === 'suspended') {
            sys.context.resume();
          }

          sys.playLoop();
        }
      });

      // Component for the STOP button
      AFRAME.registerComponent('stop-tape', {
        init: function () {
          this.onClick = this.onClick.bind(this);
          this.el.addEventListener('click', this.onClick);
        },
        remove: function () {
          this.el.removeEventListener('click', this.onClick);
        },
        onClick: function () {
          const sceneEl = this.el.sceneEl;
          const sys = sceneEl.systems['studio-audio'];
          if (!sys) return;
          sys.stopLoop();
        }
      });
    </script>
  </head>
  <body>
    <a-scene background="color: #202024">
      <!-- Lighting -->
      <a-entity light="type: ambient; intensity: 0.4"></a-entity>
      <a-entity light="type: point; intensity: 1.0; distance: 15; decay: 2"
                position="0 3 0"></a-entity>

      <!-- Floor -->
      <a-plane position="0 0 0"
               rotation="-90 0 0"
               width="12"
               height="12"
               color="#333"
               material="roughness: 0.9; metalness: 0.1">
      </a-plane>

      <!-- Walls -->
      <a-box position="0 1.5 -6"
             depth="0.1"
             height="3"
             width="12"
             color="#2a2a30">
      </a-box>
      <a-box position="-6 1.5 0"
             depth="12"
             height="3"
             width="0.1"
             color="#26262c">
      </a-box>
      <a-box position="6 1.5 0"
             depth="12"
             height="3"
             width="0.1"
             color="#26262c">
      </a-box>

      <!-- Simple mixer block -->
      <a-entity id="mixer"
                position="0 0 -2">
        <!-- Desk top -->
        <a-box position="0 0.8 0"
               depth="1.5"
               height="0.1"
               width="2.5"
               color="#1e1e22">
        </a-box>

        <!-- Mixer body -->
        <a-box position="0 1.0 0"
               depth="1.4"
               height="0.3"
               width="2.3"
               color="#22252a">
        </a-box>

        <!-- Fader placeholders -->
        <a-box position="-0.8 1.02 0.3"
               depth="0.05"
               height="0.18"
               width="0.08"
               color="#555">
        </a-box>
        <a-box position="-0.4 1.02 0.3"
               depth="0.05"
               height="0.18"
               width="0.08"
               color="#555">
        </a-box>
        <a-box position="0 1.02 0.3"
               depth="0.05"
               height="0.18"
               width="0.08"
               color="#555">
        </a-box>
        <a-box position="0.4 1.02 0.3"
               depth="0.05"
               height="0.18"
               width="0.08"
               color="#555">
        </a-box>
        <a-box position="0.8 1.02 0.3"
               depth="0.05"
               height="0.18"
               width="0.08"
               color="#555">
        </a-box>

        <!-- Knobs -->
        <a-cylinder position="-0.8 1.12 -0.2"
                    radius="0.04"
                    height="0.03"
                    color="#888">
        </a-cylinder>
        <a-cylinder position="-0.4 1.12 -0.2"
                    radius="0.04"
                    height="0.03"
                    color="#888">
        </a-cylinder>
        <a-cylinder position="0 1.12 -0.2"
                    radius="0.04"
                    height="0.03"
                    color="#888">
        </a-cylinder>
        <a-cylinder position="0.4 1.12 -0.2"
                    radius="0.04"
                    height="0.03"
                    color="#888">
        </a-cylinder>
        <a-cylinder position="0.8 1.12 -0.2"
                    radius="0.04"
                    height="0.03"
                    color="#888">
        </a-cylinder>
      </a-entity>

      <!-- Tape deck with correctly spinning reels + visible markers -->
<a-entity id="tape-deck"
          position="-2 0 -3">

  <!-- Deck body -->
  <a-box position="0 1 0"
         depth="0.5"
         height="0.4"
         width="1.4"
         color="#2b2f35">
  </a-box>

  <!-- LEFT REEL (wrapper entity rotates around its local Y axis) -->
  <a-entity position="-0.4 1.25 0.0"
            rotation="0 0 0"
            animation="property: rotation;
                       from: 0 0 0;
                       to:   0 360 0;
                       loop: true;
                       dur: 4000;
                       easing: linear">
    <!-- Reel disc -->
    <a-cylinder radius="0.18"
                height="0.05"
                color="#d0d0d0">
    </a-cylinder>

    <!-- Simple spoke/marker so rotation is visible -->
    <a-box position="0 0.03 0"
           depth="0.005"
           height="0.00"
           width="0.36"
           color="#444">
    </a-box>
  </a-entity>

  <!-- RIGHT REEL -->
  <a-entity position="0.4 1.25 0.0"
            rotation="0 0 0"
            animation="property: rotation;
                       from: 0 0 0;
                       to:   0 360 0;
                       loop: true;
                       dur: 4000;
                       easing: linear">
    <a-cylinder radius="0.18"
                height="0.05"
                color="#d0d0d0">
    </a-cylinder>

    <a-box position="0 0.03 0"
         depth="0.005"
           height="0.00"
           width="0.36"
           color="#444">
    </a-box>
  </a-entity>

  <!-- Transport buttons -->
  <!-- PLAY (green) -->
  <a-box position="-0.4 0.9 0.26"
         depth="0.06"
         height="0.04"
         width="0.12"
         color="#4caf50"
         class="clickable"
         play-tape>
  </a-box>

  <!-- PAUSE (unused for now) -->
  <a-box position="0 0.9 0.26"
         depth="0.06"
         height="0.04"
         width="0.12"
         color="#e0e0e0">
  </a-box>

  <!-- STOP (red) -->
  <a-box position="0.4 0.9 0.26"
         depth="0.06"
         height="0.04"
         width="0.12"
         color="#f44336"
         class="clickable"
         stop-tape>
  </a-box>
</a-entity>

      <!-- Camera rig -->
      <a-entity id="rig" position="-1 1.6 -0.5">
        <!-- Camera with cursor for desktop interaction -->
        <a-entity camera
                  look-controls
                  wasd-controls="acceleration: 10">
          <a-entity cursor="fuse: false"
                    raycaster="objects: .clickable"
                    position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                    material="shader: flat; color: #fff">
          </a-entity>
        </a-entity>

        <!-- VR controller rays (they appear when in VR) -->
        <a-entity laser-controls="hand: left"></a-entity>
        <a-entity laser-controls="hand: right"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
