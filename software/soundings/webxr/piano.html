<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>AR Piano</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
</head>

<body>
<a-scene xr-mode-ui="enabled: true; enterAREnabled: true; XRMode: ar;" webxr="optionalFeatures: hand-tracking">
        <a-entity id="piano" position="0 0.7 -0.3">
            <!-- piano base -->
            <a-box position="0 0 0" depth="0.3" height="0.1" width="1" color="grey"></a-box>

            <a-entity id="keys" position="0.315 0 0">
                <!-- octave 3 white keys -->
                <a-box id="C3" position="-0.63 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="D3" position="-0.58 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="E3" position="-0.53 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="F3" position="-0.48 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="G3" position="-0.43 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="A3" position="-0.38 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="B3" position="-0.33 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>

                <!-- octave 4 white keys -->
                <a-box id="C4" position="-0.28 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="D4" position="-0.23 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="E4" position="-0.18 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="F4" position="-0.13 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="G4" position="-0.08 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="A4" position="-0.03 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>
                <a-box id="B4" position="0.02 0.05 0" depth="0.25" height="0.06" width="0.045" color="white"></a-box>

                <!-- octave 3 black keys -->
                <a-box id="Db3" position="-0.605 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Eb3" position="-0.555 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Gb3" position="-0.455 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Ab3" position="-0.405 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Bb3" position="-0.355 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>

                <!-- octave 4 black keys -->
                <a-box id="Db4" position="-0.255 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Eb4" position="-0.205 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Gb4" position="-0.105 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Ab4" position="-0.055 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
                <a-box id="Bb4" position="-0.005 0.075 -0.035" depth="0.18" height="0.045" width="0.03" color="black"></a-box>
            </a-entity>
        </a-entity>

        <a-entity id="rightHand" hand-tracking-controls="hand: right;"></a-entity>
        <a-entity id="leftHand" hand-tracking-controls="hand: left;"></a-entity>
        <a-entity hand-skeleton></a-entity>
    </a-scene>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playNote(frequency) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);
            oscillator.stop(audioContext.currentTime + 1);
        }

        const noteFrequencies = {
            // octave 3
            'C3': 130.8128, 'Db3': 138.5913, 'D3': 146.8324, 'Eb3': 155.5635, 'E3': 164.8138, 'F3': 174.6141, 'Gb3': 184.9972, 'G3': 195.9977, 'Ab3': 207.6523, 'A3': 220.0000, 'Bb3': 233.0819, 'B3': 246.9417,
            // octave 4
            'C4': 261.6256, 'Db4': 277.1826, 'D4': 293.6648, 'Eb4': 311.1270, 'E4': 329.6276, 'F4': 349.2282, 'Gb4': 369.9944, 'G4': 391.9954, 'Ab4': 415.3047, 'A4': 440.0000, 'Bb4': 466.1638, 'B4': 493.8833
        };

        AFRAME.registerComponent('hand-skeleton', {
            init: function () {
                this.frame = null;
                this.referenceSpace = null;
                this.collidingKeys = { left: {}, right: {} };
                this.soundPlayed = { left: {}, right: {} };
            },

            tick: function () {
                if (!this.frame) {
                    this.frame = this.el.sceneEl.frame;
                    this.referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();
                }

                if (this.frame && this.referenceSpace) {
                    const session = this.el.sceneEl.renderer.xr.getSession();
                    const inputSources = session.inputSources;

                    for (const inputSource of inputSources) {
                        if (inputSource.hand) {
                            const handedness = inputSource.handedness;
                            this.checkKeyInteractions(inputSource.hand, handedness);
                        }
                    }
                }
            },

            checkKeyInteractions: function (hand, handedness) {
                const tipJoints = [
                    'thumb-tip', 'index-finger-tip', 'middle-finger-tip', 'ring-finger-tip', 'pinky-finger-tip'
                ];

                const keyIds = [
                    // octave 3
                    'C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'Db3', 'Eb3', 'Gb3', 'Ab3', 'Bb3',
                    // octave 4
                    'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'Db4', 'Eb4', 'Gb4', 'Ab4', 'Bb4'
                ];

                for (const keyId of keyIds) {
                    const keyEl = document.querySelector(`#${keyId}`);
                    const keyObj = keyEl.object3D;
                    const keyBB = new THREE.Box3().setFromObject(keyObj);

                    let isInteracting = false;

                    for (const jointName of tipJoints) {
                        const joint = hand.get(jointName);
                        if (joint) {
                            const jointPose = this.frame.getJointPose(joint, this.referenceSpace);
                            if (jointPose) {
                                const jointPos = new THREE.Vector3().copy(jointPose.transform.position);

                                if (keyBB.containsPoint(jointPos)) {
                                    isInteracting = true;
                                    break;
                                }
                            }
                        }
                    }

                    if (isInteracting) {
                        if (!this.collidingKeys[handedness][keyId]) {
                            this.collidingKeys[handedness][keyId] = true;
                            this.soundPlayed[handedness][keyId] = false;

                            this.changeKeyColor(keyEl, handedness);
                        }
                    } else {
                        if (this.collidingKeys[handedness][keyId]) {
                            delete this.collidingKeys[handedness][keyId];
                            delete this.soundPlayed[handedness][keyId];

                            const otherHand = handedness === 'left' ? 'right' : 'left';
                            if (!this.collidingKeys[otherHand][keyId]) {
                                this.resetKeyColor(keyEl);
                            }
                        }
                    }
                }

                this.playKeySounds(handedness);
            },

            playKeySounds: function (handedness) {
                const keyIds = Object.keys(this.collidingKeys[handedness]);

                for (const keyId of keyIds) {
                    if (!this.soundPlayed[handedness][keyId]) {
                        const frequency = noteFrequencies[keyId];
                        if (frequency) {
                            playNote(frequency);
                            this.soundPlayed[handedness][keyId] = true;
                        }
                    }
                }
            },

            changeKeyColor: function (keyEl, handedness) {
                const color = handedness === 'left' ? 'red' : 'blue';
                keyEl.setAttribute('color', color);
            },

            resetKeyColor: function (keyEl) {
                const keyId = keyEl.getAttribute('id');
                const whiteKeys = [
                    'C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'
                ];
                const blackKeys = [
                    'Db3', 'Eb3', 'Gb3', 'Ab3', 'Bb3', 'Db4', 'Eb4', 'Gb4', 'Ab4', 'Bb4'
                ];

                if (whiteKeys.includes(keyId)) {
                    keyEl.setAttribute('color', 'white');
                } else if (blackKeys.includes(keyId)) {
                    keyEl.setAttribute('color', 'black');
                }
            }
        });
    </script>
</body>

</html>